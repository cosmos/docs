# Cosmos EVM v0.5.0 Integration Documentation - Preparation Findings

**Date:** 2025-10-10
**Purpose:** Bulk data collection and organizational prep for v0.5 integration documentation rewrite
**Scope:** Fresh integrations, v0.4.x→v0.5.0 migrations, and mempool integration updates

---

## Executive Summary

This document contains all the raw findings, API changes, and structural analysis needed to rewrite three critical integration documents for Cosmos EVM v0.5.0:

1. **Fresh Integration Guide** (no EVM → EVM v0.5.0)
2. **Migration Guide** (v0.4.x → v0.5.0)
3. **Mempool Integration Doc** (updated for v0.5.0 APIs)

### Key Insights

- **v0.5.0 simplifies integration** by removing several config options and introducing cleaner APIs
- **Mempool is now configuration-based** instead of pre-built pool injection
- **Global mempool registry removed** - mempool now passed directly to JSON-RPC server
- **Keeper initialization ordering is critical** - PreciseBank must come before VM
- **Several components are optional** but current docs don't clearly denote which

---

## Section 1: API-Breaking Changes (v0.4.1 → v0.5.0-rc.0)

### Modified Files in evmd/

Based on `git diff v0.4.1..v0.5.0-rc.0 evmd/`:

```
M evmd/ante/evm_handler.go
M evmd/app.go
M evmd/cmd/evmd/cmd/testnet.go
M evmd/cmd/evmd/config/evmd_config.go
M evmd/precompiles.go
M evmd/tests/ibc/ics20_precompile_transfer_test.go
M evmd/tests/ibc/v2_ics20_precompile_transfer_test.go
M evmd/tests/network/util.go
M evmd/upgrades.go
```

**Statistics:** 9 files changed, 88 insertions(+), 20 deletions(-)

---

### 1.1 Mempool Architecture Changes (app.go)

#### REMOVED: Global Mempool Registry

**Before (v0.4.1):**

```go
// Set the global mempool for RPC access
if err := evmmempool.SetGlobalEVMMempool(evmMempool); err != nil {
    panic(err)
}
app.SetMempool(evmMempool)
```

**After (v0.5.0):**

```go
// Global registry removed - mempool passed directly to RPC server
app.SetMempool(evmMempool)
```

**Impact:** Chains must update JSON-RPC server initialization to pass mempool directly instead of relying on singleton pattern.

---

#### ADDED: App Close Method

**New in v0.5.0:**

```go
// Close unsubscribes from the CometBFT event bus (if set) and closes the underlying BaseApp.
func (app *EVMD) Close() error {
    var err error
    if m, ok := app.GetMempool().(*evmmempool.ExperimentalEVMMempool); ok {
        err = m.Close()
    }
    err = errors.Join(err, app.BaseApp.Close())
    msg := "Application gracefully shutdown"
    if err == nil {
        app.Logger().Info(msg)
    } else {
        app.Logger().Error(msg, "error", err)
    }
    return err
}
```

**Purpose:** Proper cleanup of mempool resources and event bus subscriptions.
**Required:** Apps must implement this method to prevent resource leaks.

---

#### CHANGED: Import Statement

**New import in v0.5.0:**

```go
import (
    "encoding/json"
    "errors"  // ← NEW
    "fmt"
    "io"
    // ...
)
```

**Purpose:** Used in new `Close()` method with `errors.Join()`.

---

### 1.2 Mempool Config Structure Changes

#### REMOVED: Pre-built Pool Injection

**Before (v0.4.1):**

```go
type EVMMempoolConfig struct {
    TxPool        *txpool.TxPool                                 // ← REMOVED
    CosmosPool    sdkmempool.ExtMempool                          // ← REMOVED
    AnteHandler   sdk.AnteHandler
    BroadCastTxFn func(txs []*ethtypes.Transaction) error
    BlockGasLimit uint64
}
```

**After (v0.5.0):**

```go
type EVMMempoolConfig struct {
    LegacyPoolConfig *legacypool.Config                                    // ← NEW
    CosmosPoolConfig *sdkmempool.PriorityNonceMempoolConfig[math.Int]      // ← NEW
    AnteHandler      sdk.AnteHandler
    BroadCastTxFn    func(txs []*ethtypes.Transaction) error
    BlockGasLimit    uint64
}
```

**Rationale:**

- Configuration-based approach is more flexible
- Pools are now created internally by `NewExperimentalEVMMempool()`
- Simplifies integration - no need to pre-construct pools
- Better separation of concerns

---

### 1.3 Precompile Constructor Signature Changes (precompiles.go)

#### CHANGED: ICS-20 Transfer Precompile

**Before (v0.4.1):**

```go
ibcTransferPrecompile, err := ics20precompile.NewPrecompile(
    stakingKeeper,
    transferKeeper,
    channelKeeper,
)
```

**After (v0.5.0):**

```go
ibcTransferPrecompile, err := ics20precompile.NewPrecompile(
    bankKeeper,    // ← NEW - added as first parameter
    stakingKeeper,
    transferKeeper,
    channelKeeper,
)
```

**Reason:** ICS-20 precompile now needs bank keeper for additional token operations.

---

#### CHANGED: Gov Precompile

**Before (v0.4.1):**

```go
govPrecompile, err := govprecompile.NewPrecompile(
    govKeeper,
    cdc,
)
```

**After (v0.5.0):**

```go
govPrecompile, err := govprecompile.NewPrecompile(
    govkeeper.NewMsgServerImpl(&govKeeper),  // ← CHANGED to msg server
    govkeeper.NewQueryServer(&govKeeper),     // ← CHANGED to query server
    bankKeeper,                                // ← NEW
    codec,                                     // ← renamed from cdc
    options.AddressCodec,                      // ← NEW
)
```

**Reason:** Decoupling from keeper - uses interfaces instead for better modularity.

---

#### NO CHANGE: Optional Params Pattern

The `Optionals` struct and functional options pattern remain unchanged from v0.4.x:

```go
type Optionals struct {
    AddressCodec       address.Codec // used by gov/staking
    ValidatorAddrCodec address.Codec // used by slashing
    ConsensusAddrCodec address.Codec // used by slashing
}

func defaultOptionals() Optionals {
    return Optionals{
        AddressCodec:       addresscodec.NewBech32Codec(sdk.GetConfig().GetBech32AccountAddrPrefix()),
        ValidatorAddrCodec: addresscodec.NewBech32Codec(sdk.GetConfig().GetBech32ValidatorAddrPrefix()),
        ConsensusAddrCodec: addresscodec.NewBech32Codec(sdk.GetConfig().GetBech32ConsensusAddrPrefix()),
    }
}
```

---

### 1.4 Ante Handler Changes (ante/evm_handler.go)

**File appears to be simplified but no major API breaking changes in the public interface.**

The ante handler setup in app.go remains conceptually the same:

- Still uses `ante.NewAnteHandler(options)`
- Options struct likely has internal changes but external API is stable

---

### 1.5 Upgrade Handler (upgrades.go)

**New file added in v0.5.0 with reference upgrade handler:**

```go
const UpgradeName = "v0.4.0-to-v0.5.0"

func (app EVMD) RegisterUpgradeHandlers() {
    app.UpgradeKeeper.SetUpgradeHandler(
        UpgradeName,
        func(ctx context.Context, _ upgradetypes.Plan, fromVM module.VersionMap) (module.VersionMap, error) {
            sdk.UnwrapSDKContext(ctx).Logger().Debug("this is a debug level message to test that verbose logging mode has properly been enabled during a chain upgrade")
            return app.ModuleManager.RunMigrations(ctx, app.Configurator(), fromVM)
        },
    )

    upgradeInfo, err := app.UpgradeKeeper.ReadUpgradeInfoFromDisk()
    if err != nil {
        panic(err)
    }

    if upgradeInfo.Name == UpgradeName && !app.UpgradeKeeper.IsSkipHeight(upgradeInfo.Height) {
        storeUpgrades := storetypes.StoreUpgrades{
            Added: []string{}, // No new stores added in v0.5.0
        }
        app.SetStoreLoader(upgradetypes.UpgradeStoreLoader(upgradeInfo.Height, &storeUpgrades))
    }
}
```

**Key Points:**

- No store migrations required for v0.5.0 upgrade
- Standard module migrations handled by `RunMigrations()`
- Example shows proper verbose logging during upgrades

---

## Section 2: Component-Based API Change Categorization

Instead of organizing by file, here are the changes grouped by logical component:

### 2.1 Mempool Component

**Changes:**

1. **Config struct refactor** - Pre-built pools → Configuration objects
2. **Global registry removal** - Singleton pattern → Direct injection
3. **Cleanup lifecycle** - New `Close()` method for proper shutdown
4. **Event bus integration** - Mempool now subscribes to CometBFT events

**Migration Steps:**

1. Remove `SetGlobalEVMMempool()` call from app constructor
2. Update `EVMMempoolConfig` to use `LegacyPoolConfig` and `CosmosPoolConfig`
3. Add `Close()` method to app
4. Pass mempool to RPC server initialization explicitly

**Optional vs Required:**

- **REQUIRED:** Basic mempool setup with `AnteHandler` and `BlockGasLimit`
- **OPTIONAL:** Custom `LegacyPoolConfig` (defaults provided)
- **OPTIONAL:** Custom `CosmosPoolConfig` (defaults provided)
- **OPTIONAL:** Custom `BroadcastTxFn` (default uses `clientCtx`)

---

### 2.2 Precompiles Component

**Changes:**

1. **ICS-20 constructor** - Added `bankKeeper` as first parameter
2. **Gov constructor** - Changed from keeper to msg/query servers + bank keeper + address codec
3. **Staking/Distribution constructors** - Changed to use msg/query server pattern (if similar to gov)

**Migration Steps:**

1. Update ICS-20 precompile call to include `bankKeeper`
2. Update Gov precompile to use msg server, query server, bank keeper, and address codec
3. Verify all precompile constructors match new signatures

**Optional vs Required:**

- **REQUIRED:** Staking, Distribution, Bank precompiles (core functionality)
- **OPTIONAL:** Gov precompile (governance features)
- **OPTIONAL:** Slashing precompile (validator slashing)
- **OPTIONAL:** ICS-20 precompile (IBC transfers via EVM)

---

### 2.3 Ante Handler Component

**Changes:**

- Internal optimizations
- No major public API changes identified

**Migration Steps:**

- No changes required to existing ante handler setup

---

### 2.4 App Lifecycle Component

**Changes:**

1. **Close method** - New required method for cleanup
2. **clientCtx handling** - Existing `SetClientCtx()` method remains required

**Migration Steps:**

1. Implement `Close()` method in app
2. Ensure `SetClientCtx()` is implemented (should already exist from v0.4.x)

**Required:**

- **REQUIRED:** `Close()` method
- **REQUIRED:** `SetClientCtx()` method
- **REQUIRED:** `clientCtx client.Context` field in app struct

---

### 2.5 VM Parameters Component

**Changes:**

1. **REMOVED:** `allow_unprotected_txs` parameter
2. **ADDED:** `history_serve_window` parameter (default: 8192)

**Migration Steps:**

1. Remove `allow_unprotected_txs` from genesis files
2. Add `history_serve_window: 8192` to genesis files
3. Remove any code referencing `AllowUnprotectedTxs`

**Purpose:**

- `history_serve_window` supports EIP-2935 (block hash storage)

---

## Section 3: Keeper Initialization Ordering Requirements

Based on analysis of evmd/app.go from v0.5.0:

### Critical Ordering Requirements

```
1. Standard Cosmos SDK Keepers (order matters for some):
   AccountKeeper
   BankKeeper
   StakingKeeper
   ... other SDK keepers

2. FeeMarket Keeper
   ↓ (must come before PreciseBank and VM)

3. PreciseBank Keeper ⚠️ CRITICAL
   ↓ (MUST be initialized BEFORE VM keeper)

4. VM Keeper
   ↓ (needs PreciseBank, FeeMarket)

5. ERC20 Keeper
   ↓ (needs VM keeper)

6. Transfer Keeper (IBC)
   ↓ (can reference ERC20 keeper)

7. Precompiles Registration
   ↓ (needs all keepers ready)

8. EVM Mempool
   ↓ (needs VM keeper, FeeMarket keeper, and ante handler set)
```

### Dependency Graph

```
AccountKeeper → PreciseBank ───┐
BankKeeper ─────────────────────┤
FeeMarketKeeper ────────────────┼→ VM Keeper → ERC20 Keeper
ConsensusParamsKeeper ──────────┤             ↓
StakingKeeper ──────────────────┘             Transfer Keeper
                                              ↓
                                              Precompiles
                                              ↓
                                              EVM Mempool
```

### Why Ordering Matters

1. **PreciseBank before VM:**

   - VM keeper depends on PreciseBank for 18-decimal precision token operations
   - Compilation will succeed but runtime panics occur if order is wrong

2. **FeeMarket before VM:**

   - VM needs FeeMarket for gas pricing

3. **ERC20 after VM:**

   - ERC20 module interacts with EVM state

4. **Transfer after ERC20:**

   - IBC transfer needs ERC20 keeper for token conversions

5. **Mempool after all keepers:**
   - Mempool needs VM, FeeMarket, and ante handler (which depends on many keepers)

---

## Section 4: Optional vs Required Components

### Required Components ✓

These components are **essential** for basic EVM functionality:

1. **VM Module** (`x/vm`)

   - Core EVM execution engine
   - Cannot run EVM without this

2. **FeeMarket Module** (`x/feemarket`)

   - EIP-1559 dynamic fee support
   - Required for gas pricing

3. **PreciseBank Module** (`x/precisebank`)

   - 18-decimal precision for EVM tokens
   - Required for proper ERC20 token handling

4. **ERC20 Module** (`x/erc20`)

   - ERC20 token bridge between Cosmos and EVM
   - Required for token interoperability

5. **Core Precompiles**

   - Bank precompile - token operations
   - Bech32 precompile - address conversion
   - P256 precompile - EIP-7212 signature verification

6. **EVM Mempool**

   - Required for proper EVM transaction handling
   - Supports nonce gap queuing

7. **Ante Handlers**

   - EVM ante handler for EVM tx validation
   - Required for security

8. **App Lifecycle Methods**
   - `SetClientCtx()`
   - `Close()`
   - `RegisterPendingTxListener()`
   - `onPendingTx()`

---

### Optional Components (Can be excluded)

1. **Staking Precompile**

   - Use case: EVM contracts calling staking operations
   - Can omit if not needed

2. **Distribution Precompile**

   - Use case: EVM contracts claiming rewards
   - Can omit if not needed

3. **Gov Precompile**

   - Use case: EVM contracts submitting proposals
   - Can omit if not needed

4. **Slashing Precompile**

   - Use case: EVM contracts unjailing validators
   - Can omit if not needed

5. **ICS-20 Transfer Precompile**

   - Use case: EVM contracts initiating IBC transfers
   - Can omit if IBC not used or not needed from EVM

6. **Custom Mempool Configs**

   - Use case: Fine-tuning mempool behavior
   - Defaults are sufficient for most chains

7. **IBC Transfer Override**
   - Use case: IBC transfers of ERC20 tokens
   - Can use standard IBC transfer if not needed

---

## Section 5: Fresh Integration Step-by-Step Outline

Based on evmd reference implementation in v0.5.0:

### High-Level Component Flow

```
1. Dependencies & Imports
2. App Struct Definition
3. Store Keys Registration
4. Keeper Initialization (order matters!)
5. Module Wiring
6. Precompiles Registration
7. Ante Handler Setup
8. Mempool Configuration
9. Module Manager & Begin/EndBlockers
10. Init Genesis & Export
```

---

### Detailed Steps (Component-Based)

#### Component: Dependencies

1. Add `github.com/cosmos/evm v0.5.0` to go.mod
2. Add replace directive for go-ethereum fork
3. Run `go mod tidy`

**Ordering:** N/A (first step)

---

#### Component: Store Keys

1. Add EVM store keys to `keys` map:

   - `evmtypes.StoreKey`
   - `feemarkettypes.StoreKey`
   - `erc20types.StoreKey`
   - `precisebanktypes.StoreKey`

2. Add EVM transient keys to `tkeys` map:
   - `evmtypes.TransientKey`
   - `feemarkettypes.TransientKey`

**Ordering:** Before keeper initialization

---

#### Component: PreciseBank Keeper

1. Initialize PreciseBank keeper:

```go
app.PreciseBankKeeper = precisebankkeeper.NewKeeper(
    appCodec,
    runtime.NewKVStoreService(keys[precisebanktypes.StoreKey]),
    app.AccountKeeper,
    app.BankKeeper,
    authtypes.NewModuleAddress(govtypes.ModuleName),
    logger,
)
```

**Ordering:** MUST come before VM keeper
**Dependencies:** AccountKeeper, BankKeeper, govtypes (for authority address)
**Optional:** NO - Required for proper EVM token handling

---

#### Component: FeeMarket Keeper

1. Initialize FeeMarket keeper:

```go
app.FeeMarketKeeper = feemarketkeeper.NewKeeper(
    appCodec,
    authtypes.NewModuleAddress(govtypes.ModuleName),
    runtime.NewKVStoreService(keys[feemarkettypes.StoreKey]),
    runtime.NewTransientStoreService(tkeys[feemarkettypes.TransientKey]),
    app.GetSubspace(feemarkettypes.ModuleName),
)
```

**Ordering:** MUST come before VM keeper
**Dependencies:** govtypes (for authority address)
**Optional:** NO - Required for EIP-1559 gas pricing

---

#### Component: VM Keeper

1. Initialize VM keeper:

```go
app.EVMKeeper = evmkeeper.NewKeeper(
    appCodec,
    keys[evmtypes.StoreKey],
    tkeys[evmtypes.TransientKey],
    authtypes.NewModuleAddress(govtypes.ModuleName),
    app.AccountKeeper,
    app.PreciseBankKeeper,  // ⚠️ Must be initialized before this
    app.StakingKeeper,
    app.FeeMarketKeeper,    // ⚠️ Must be initialized before this
    &app.ConsensusParamsKeeper,
    &app.Erc20Keeper,  // Note: circular reference handled via pointer
    tracer,
)
```

**Ordering:** After PreciseBank and FeeMarket, before ERC20
**Dependencies:** PreciseBank, FeeMarket, Account, Staking, ConsensusParams
**Optional:** NO - Core EVM execution engine

---

#### Component: ERC20 Keeper

1. Initialize ERC20 keeper:

```go
app.Erc20Keeper = erc20keeper.NewKeeper(
    keys[erc20types.StoreKey],
    appCodec,
    authtypes.NewModuleAddress(govtypes.ModuleName),
    app.AccountKeeper,
    app.PreciseBankKeeper,
    app.EVMKeeper,  // ⚠️ Must be initialized before this
    app.StakingKeeper,
    &app.TransferKeeper,  // Note: circular reference via pointer
)
```

**Ordering:** After VM keeper, before Transfer keeper
**Dependencies:** VM, PreciseBank, Account, Staking
**Optional:** NO - Required for ERC20 token bridge

---

#### Component: IBC Transfer Keeper (EVM-enhanced)

1. Initialize Transfer keeper with EVM override:

```go
app.TransferKeeper = transferkeeper.NewKeeper(
    appCodec,
    runtime.NewKVStoreService(keys[ibctransfertypes.StoreKey]),
    app.GetSubspace(ibctransfertypes.ModuleName),
    app.IBCKeeper.ChannelKeeper,
    app.IBCKeeper.ChannelKeeper,
    app.MsgServiceRouter(),
    app.AccountKeeper,
    app.BankKeeper,
    app.Erc20Keeper,  // ⚠️ ERC20 keeper for token conversions
    authAddr,
)
```

**Ordering:** After ERC20 keeper
**Dependencies:** IBC, ERC20, Account, Bank
**Optional:** If not using IBC, can use standard transfer keeper

---

#### Component: Precompiles

1. Register static precompiles on VM keeper:

```go
app.EVMKeeper.WithStaticPrecompiles(
    NewAvailableStaticPrecompiles(
        *app.StakingKeeper,
        app.DistrKeeper,
        app.PreciseBankKeeper,
        app.Erc20Keeper,
        app.TransferKeeper,
        app.IBCKeeper.ChannelKeeper,
        app.EVMKeeper,
        app.GovKeeper,
        app.SlashingKeeper,
        app.AppCodec(),
    ),
)
```

**Ordering:** After all keepers initialized
**Dependencies:** All keepers used by precompiles
**Optional:** Can customize which precompiles to include (see Section 4)

---

#### Component: Ante Handler

1. Set up ante handler with EVM options:

```go
app.setAnteHandler(app.txConfig, maxGasWanted)
```

Where `setAnteHandler` creates options:

```go
options := ante.HandlerOptions{
    AccountKeeper:          app.AccountKeeper,
    BankKeeper:             app.BankKeeper,
    ExtensionOptionChecker: cosmosevmtypes.HasDynamicFeeExtensionOption,
    EvmKeeper:              app.EVMKeeper,
    FeegrantKeeper:         app.FeeGrantKeeper,
    IBCKeeper:              app.IBCKeeper,
    FeeMarketKeeper:        app.FeeMarketKeeper,
    SignModeHandler:        txConfig.SignModeHandler(),
    SigGasConsumer:         evmante.SigVerificationGasConsumer,
    MaxTxGasWanted:         maxGasWanted,
    TxFeeChecker:           cosmosevmante.NewDynamicFeeChecker(app.FeeMarketKeeper),
    PendingTxListener:      app.onPendingTx,  // ⚠️ For mempool integration
}
```

**Ordering:** After all keepers, before mempool
**Dependencies:** All keepers, txConfig
**Optional:** NO - Required for transaction validation

---

#### Component: EVM Mempool

1. Configure and initialize mempool:

```go
if evmtypes.GetChainConfig() != nil {
    mempoolConfig := &evmmempool.EVMMempoolConfig{
        AnteHandler:   app.GetAnteHandler(),  // ⚠️ Must be set first
        BlockGasLimit: 100_000_000,
    }

    evmMempool := evmmempool.NewExperimentalEVMMempool(
        app.CreateQueryContext,
        logger,
        app.EVMKeeper,
        app.FeeMarketKeeper,
        app.txConfig,
        app.clientCtx,  // ⚠️ Must be set via SetClientCtx()
        mempoolConfig,
    )
    app.EVMMempool = evmMempool

    app.SetMempool(evmMempool)
    checkTxHandler := evmmempool.NewCheckTxHandler(evmMempool)
    app.SetCheckTxHandler(checkTxHandler)

    abciProposalHandler := baseapp.NewDefaultProposalHandler(evmMempool, app)
    abciProposalHandler.SetSignerExtractionAdapter(
        evmmempool.NewEthSignerExtractionAdapter(
            sdkmempool.NewDefaultSignerExtractionAdapter(),
        ),
    )
    app.SetPrepareProposal(abciProposalHandler.PrepareProposalHandler())
}
```

**Ordering:** After ante handler set
**Dependencies:** VM keeper, FeeMarket keeper, txConfig, clientCtx, ante handler
**Optional:** NO - Required for proper EVM transaction handling

---

#### Component: Module Manager

1. Register EVM modules:

```go
app.ModuleManager = module.NewManager(
    // ... standard SDK modules
    vm.NewAppModule(appCodec, app.EVMKeeper, app.AccountKeeper),
    feemarket.NewAppModule(app.FeeMarketKeeper),
    erc20.NewAppModule(app.Erc20Keeper, app.AccountKeeper, app.BankKeeper),
    precisebank.NewAppModule(app.PreciseBankKeeper, app.AccountKeeper, app.BankKeeper),
    transfer.NewAppModule(app.TransferKeeper),  // EVM-enhanced version
)
```

2. Set Begin/EndBlocker order:

```go
app.ModuleManager.SetOrderBeginBlockers(
    // ...
    feemarkettypes.ModuleName,  // Update base fee
    erc20types.ModuleName,
    evmtypes.ModuleName,  // Must come after FeeMarket
    // ...
)

app.ModuleManager.SetOrderEndBlockers(
    // ...
    evmtypes.ModuleName,
    erc20types.ModuleName,
    feemarkettypes.ModuleName,  // Must come last to get full block gas
    // ...
)
```

**Ordering:** After all keepers and mempool
**Optional:** NO - Required for module lifecycle

---

#### Component: App Lifecycle Methods

1. Implement required interface methods:

```go
func (app *App) SetClientCtx(clientCtx client.Context) {
    app.clientCtx = clientCtx
}

func (app *App) RegisterPendingTxListener(listener func(common.Hash)) {
    app.pendingTxListeners = append(app.pendingTxListeners, listener)
}

func (app *App) onPendingTx(hash common.Hash) {
    for _, listener := range app.pendingTxListeners {
        listener(hash)
    }
}

func (app *App) Close() error {
    var err error
    if m, ok := app.GetMempool().(*evmmempool.ExperimentalEVMMempool); ok {
        err = m.Close()
    }
    err = errors.Join(err, app.BaseApp.Close())
    msg := "Application gracefully shutdown"
    if err == nil {
        app.Logger().Info(msg)
    } else {
        app.Logger().Error(msg, "error", err)
    }
    return err
}
```

**Ordering:** N/A (helper methods)
**Optional:** NO - Required by interfaces

---

## Section 6: Migration Path (v0.4.x → v0.5.0)

### Component-by-Component Migration

#### A. Mempool Migration

**Required Actions:**

1. Remove `SetGlobalEVMMempool()` call
2. Update `EVMMempoolConfig` structure:
   - Remove: `TxPool` field
   - Remove: `CosmosPool` field
   - Add: `LegacyPoolConfig` (optional)
   - Add: `CosmosPoolConfig` (optional)
3. Add `Close()` method to app
4. Update RPC server initialization to pass mempool directly

**Example Diff:**

```diff
  mempoolConfig := &evmmempool.EVMMempoolConfig{
-     TxPool:        customTxPool,
-     CosmosPool:    customCosmosPool,
+     LegacyPoolConfig: &legacypool.Config{...},  // optional
+     CosmosPoolConfig: &sdkmempool.PriorityNonceMempoolConfig[math.Int]{...},  // optional
      AnteHandler:   app.GetAnteHandler(),
      BlockGasLimit: 100_000_000,
  }

  evmMempool := evmmempool.NewExperimentalEVMMempool(...)
  app.EVMMempool = evmMempool

- if err := evmmempool.SetGlobalEVMMempool(evmMempool); err != nil {
-     panic(err)
- }
  app.SetMempool(evmMempool)
```

---

#### B. Precompiles Migration

**Required Actions:**

1. Update ICS-20 precompile constructor to include `bankKeeper`
2. Update Gov precompile constructor to use msg/query servers + bank + codec
3. Verify address codec options are passed correctly

**Example Diff:**

```diff
  // ICS-20 Precompile
  ibcTransferPrecompile, err := ics20precompile.NewPrecompile(
+     bankKeeper,
      stakingKeeper,
      transferKeeper,
      channelKeeper,
  )

  // Gov Precompile
- govPrecompile, err := govprecompile.NewPrecompile(govKeeper, cdc)
+ govPrecompile, err := govprecompile.NewPrecompile(
+     govkeeper.NewMsgServerImpl(&govKeeper),
+     govkeeper.NewQueryServer(&govKeeper),
+     bankKeeper,
+     codec,
+     options.AddressCodec,
+ )
```

---

#### C. VM Parameters Migration

**Required Actions:**

1. Remove `allow_unprotected_txs` from genesis
2. Add `history_serve_window` to genesis
3. Remove code referencing `AllowUnprotectedTxs`

**Genesis Diff:**

```diff
  {
    "app_state": {
      "vm": {
        "params": {
          "evm_denom": "atest",
          "extra_eips": [],
-         "allow_unprotected_txs": false,
          "evm_channels": [],
          "access_control": {...},
          "active_static_precompiles": [...],
+         "history_serve_window": 8192
        }
      }
    }
  }
```

---

#### D. App Lifecycle Migration

**Required Actions:**

1. Add `Close()` method to app (if not already present from v0.4.x)
2. Add `errors` import

**Example:**

```diff
+ import (
+     "errors"
+     // ...
+ )

+ func (app *App) Close() error {
+     var err error
+     if m, ok := app.GetMempool().(*evmmempool.ExperimentalEVMMempool); ok {
+         err = m.Close()
+     }
+     err = errors.Join(err, app.BaseApp.Close())
+     msg := "Application gracefully shutdown"
+     if err == nil {
+         app.Logger().Info(msg)
+     } else {
+         app.Logger().Error(msg, "error", err)
+     }
+     return err
+ }
```

---

## Section 7: Mempool Integration Updates

### Key Changes for Mempool Integration Doc

1. **Remove Section:** Global mempool registry (`SetGlobalEVMMempool`)

   - This is no longer used in v0.5.0
   - Update docs to show mempool passed to RPC server

2. **Update Section:** Configuration structure

   - Show new `LegacyPoolConfig` and `CosmosPoolConfig` fields
   - Explain that pools are no longer pre-built

3. **Add Section:** App cleanup

   - Document the `Close()` method requirement
   - Explain event bus cleanup

4. **Update Section:** RPC server initialization
   - Show how to pass mempool to RPC server directly
   - Remove references to global singleton

### Updated Configuration Example

**Current Doc (v0.4.x style):**

```go
mempoolConfig := &evmmempool.EVMMempoolConfig{
    TxPool:        customTxPool,      // Build pool yourself
    CosmosPool:    customCosmosPool,  // Build pool yourself
    AnteHandler:   app.GetAnteHandler(),
    BlockGasLimit: 100_000_000,
}
```

**Should Be (v0.5.0 style):**

```go
mempoolConfig := &evmmempool.EVMMempoolConfig{
    // Optional: Customize pool behavior via config
    LegacyPoolConfig: &legacypool.Config{
        AccountSlots: 16,
        GlobalSlots:  5120,
        PriceLimit:   1,
    },

    // Optional: Customize Cosmos mempool
    CosmosPoolConfig: &sdkmempool.PriorityNonceMempoolConfig[math.Int]{
        TxPriority: customPriorityConfig,
    },

    // Required
    AnteHandler:   app.GetAnteHandler(),
    BlockGasLimit: 100_000_000,
}
```

---

## Section 8: Summary of Documentation Changes Needed

### Fresh Integration Guide

**Sections to Add:**

1. Component dependency graph visual
2. Keeper initialization ordering rules
3. Optional vs required components table
4. Step-by-step with ordering annotations

**Sections to Update:**

1. Mempool setup (remove global registry)
2. Precompile constructors (updated signatures)
3. App lifecycle methods (add `Close()`)

---

### Migration Guide (v0.4.x → v0.5.0)

**Sections to Add:**

1. Mempool refactor section (config-based vs pre-built)
2. VM parameters migration
3. App cleanup lifecycle

**Sections to Update:**

1. Precompile migration (ICS-20 + Gov changes)
2. Breaking changes summary (categorize by component)

---

### Mempool Integration Doc

**Sections to Remove:**

1. Global mempool registry setup
2. Pre-built pool construction examples

**Sections to Add:**

1. Configuration-based approach
2. App `Close()` method
3. RPC server mempool injection

**Sections to Update:**

1. Configuration struct documentation
2. Default behaviors
3. Custom configuration examples

---

## Section 9: Key Documentation Principles

Based on user requirements, the rewritten docs should follow these principles:

### 1. Component-Based Organization

**DON'T:**

```
- "Change app.go line X"
- "Update app.go here"
- "Modify app.go again"
```

**DO:**

```
- "Mempool Component: Configure in app.go"
- "Precompiles Component: Register after keepers"
- "Ante Handler Component: Set before mempool"
```

---

### 2. Ordering Clarity

**Always Specify:**

- "Must be initialized BEFORE X"
- "Must come AFTER Y"
- "Order with other modules: [list]"

**Example:**

> **PreciseBank Keeper Initialization**
>
> ⚠️ **CRITICAL:** Must be initialized BEFORE the VM keeper.
>
> **Ordering:**
>
> - After: AccountKeeper, BankKeeper
> - Before: VM Keeper
>
> **Why:** VM keeper depends on PreciseBank for 18-decimal token operations.

---

### 3. Optional vs Required Tags

**Every Component Should Have:**

```
✅ REQUIRED - Core EVM functionality
❌ OPTIONAL - Enhanced features
```

**Example:**

> **ICS-20 Transfer Precompile**
>
> ❌ **OPTIONAL**
>
> **Use Case:** Enable IBC token transfers from EVM contracts
>
> **Can Skip If:** Chain doesn't need IBC integration from EVM side

---

### 4. Clear Dependencies

**Every Component Should List:**

- **Depends On:** What must exist first
- **Required By:** What needs this component
- **Circular References:** How they're handled

**Example:**

> **ERC20 Keeper**
>
> **Depends On:**
>
> - VM Keeper
> - PreciseBank Keeper
> - Account Keeper
>
> **Required By:**
>
> - IBC Transfer Keeper (for token conversions)
> - Bank Precompile (for balance queries)
>
> **Note:** VM keeper has pointer to ERC20 keeper (circular dependency handled via pointer)

---

## Section 10: Next Steps

### For Integration Guide Rewrite

1. ✅ Use findings from this document
2. ✅ Create component-based flow diagram
3. ✅ Write component sections with ordering + dependencies
4. ✅ Add optional vs required tables
5. ✅ Include troubleshooting for common ordering mistakes

### For Migration Guide Rewrite

1. ✅ Use API changes from Section 1
2. ✅ Organize by component (Section 2 categorization)
3. ✅ Add before/after code examples
4. ✅ Include upgrade handler reference
5. ✅ Add migration checklist

### For Mempool Doc Update

1. ✅ Use mempool changes from Section 1.1, 1.2
2. ✅ Update configuration structure docs
3. ✅ Remove global registry references
4. ✅ Add `Close()` method docs
5. ✅ Update RPC server initialization

---

## Appendix A: Reference Files

### evmd v0.5.0-rc.0 Reference Locations

- **app.go:** `/Users/cordt/repos/evm/evmd/app.go`
- **precompiles.go:** `/Users/cordt/repos/evm/evmd/precompiles.go`
- **ante/evm_handler.go:** `/Users/cordt/repos/evm/evmd/ante/evm_handler.go`
- **upgrades.go:** `/Users/cordt/repos/evm/evmd/upgrades.go`
- **mempool/README.md:** `/Users/cordt/repos/evm/mempool/README.md`
- **mempool/mempool.go:** `/Users/cordt/repos/evm/mempool/mempool.go`

### Existing Documentation Locations

- **Fresh Integration Guide:** `/Users/cordt/repos/docs/docs/evm/next/documentation/integration/fresh-v0.5-integration.mdx`
- **Migration Guide:** `/Users/cordt/repos/docs/docs/evm/next/documentation/integration/migration-v0.4-to-v0.5.mdx`
- **Mempool Integration:** `/Users/cordt/repos/docs/docs/evm/next/documentation/getting-started/build-a-chain/additional-configuration/mempool-integration.mdx.mdx`

---

## Appendix B: Quick Reference Tables

### Keeper Initialization Order

| Order | Keeper            | Must Come After             | Must Come Before |
| ----- | ----------------- | --------------------------- | ---------------- |
| 1     | AccountKeeper     | -                           | PreciseBank      |
| 2     | BankKeeper        | -                           | PreciseBank      |
| 3     | StakingKeeper     | AccountKeeper               | VM               |
| 4     | FeeMarketKeeper   | -                           | VM               |
| 5     | PreciseBankKeeper | Account, Bank               | VM               |
| 6     | VMKeeper          | PreciseBank, FeeMarket      | ERC20            |
| 7     | Erc20Keeper       | VM                          | Transfer         |
| 8     | TransferKeeper    | ERC20                       | Precompiles      |
| 9     | Precompiles       | All keepers                 | Mempool          |
| 10    | EVMMempool        | Ante handler, VM, FeeMarket | -                |

---

### Optional Components Quick Reference

| Component               | Required? | Reason if Optional            |
| ----------------------- | --------- | ----------------------------- |
| VM Module               | ✅ YES    | Core EVM execution            |
| FeeMarket Module        | ✅ YES    | Gas pricing                   |
| PreciseBank Module      | ✅ YES    | 18-decimal precision          |
| ERC20 Module            | ✅ YES    | Token interoperability        |
| Staking Precompile      | ❌ NO     | Only if EVM needs staking ops |
| Distribution Precompile | ❌ NO     | Only if EVM needs rewards     |
| Gov Precompile          | ❌ NO     | Only if EVM needs governance  |
| Slashing Precompile     | ❌ NO     | Only if EVM needs slashing    |
| ICS-20 Precompile       | ❌ NO     | Only if EVM needs IBC         |
| Custom Mempool Config   | ❌ NO     | Defaults sufficient for most  |
| IBC Transfer Override   | ❌ NO     | Only for ERC20 IBC transfers  |

---

### API Breaking Changes Quick Reference

| Component         | Change Type        | v0.4.1                             | v0.5.0                                                              |
| ----------------- | ------------------ | ---------------------------------- | ------------------------------------------------------------------- |
| Mempool Config    | Field Removal      | `TxPool *txpool.TxPool`            | Removed                                                             |
| Mempool Config    | Field Removal      | `CosmosPool sdkmempool.ExtMempool` | Removed                                                             |
| Mempool Config    | Field Addition     | -                                  | `LegacyPoolConfig *legacypool.Config`                               |
| Mempool Config    | Field Addition     | -                                  | `CosmosPoolConfig *sdkmempool.PriorityNonceMempoolConfig[math.Int]` |
| Mempool           | Function Removal   | `SetGlobalEVMMempool()`            | Removed                                                             |
| App               | Method Addition    | -                                  | `Close() error`                                                     |
| ICS-20 Precompile | Constructor Change | 3 params                           | 4 params (added `bankKeeper`)                                       |
| Gov Precompile    | Constructor Change | 2 params                           | 5 params (msg/query servers + bank + codec)                         |
| VM Params         | Parameter Removal  | `allow_unprotected_txs`            | Removed                                                             |
| VM Params         | Parameter Addition | -                                  | `history_serve_window`                                              |

---

**End of Findings Document**
