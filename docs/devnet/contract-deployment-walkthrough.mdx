# Complete Contract Deployment Walkthrough

A comprehensive guide to deploying and interacting with contracts on Cosmos EVM.

## Prerequisites

### Environment Setup

Before starting, verify your development environment:

```bash
# Check Node.js version (v22.14.0 was used in this example)
node --version

# Check Foundry installation
forge --version (1.2.3-stable was used in this example)

# Test network connectivity
curl -s https://devnet-1-evmrpc.ib.skip.build \
  -X POST \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"eth_chainId","params":[],"id":1}'
```

Expected response: `{"jsonrpc":"2.0","id":1,"result":"0x10e1"}` (Chain ID: 4321)

### Required Tools

- **Foundry**: Contract compilation and deployment
- **Node.js**: Script execution and RPC interactions
- **curl**: Network testing and verification

## Step 1: Clean Environment

Always start with a clean compilation environment:

```bash
# Remove all cached artifacts
rm -rf out cache broadcast deployments/*.json
forge clean
```

This prevents deployment issues caused by stale contract artifacts.

## Step 2: Contract Compilation

Compile your Solidity contracts:

```bash
forge build
```

Expected output:
```
Compiling 31 files with Solc 0.8.28
Solc 0.8.28 finished in 934.27ms
Compiler run successful!
```

## Step 3: Deploy Contract

### Set Up Environment Variables

```bash
# Set your private key (use environment variable for security)
export PRIVATE_KEY="0x...."
```

### Deploy Using Foundry Script

```bash
forge script script/DeployAtomicMultiSend.s.sol \
  --rpc-url https://cevm-01-evmrpc.dev.skip.build \
  --broadcast \
  --skip-simulation
```

### Successful Deployment Output

```
Script ran successfully.

== Logs ==
  ==============================================
  ATOMIC MULTISEND CONTRACT DEPLOYMENT
  ==============================================
  Deployer: 0x42e6047c5780B103E52265F6483C2d0113aA6B87
  Faucet Address: 0x42e6047c5780B103E52265F6483C2d0113aA6B87
  Chain ID: 262144
  Block Number: 599458
  Timestamp: 1749997423
  ==============================================

Deploying AtomicMultiSend Contract...
  AtomicMultiSend deployed at: 0x247CA16B2Fc5c9ae031e83c317c6DC6933Db7246
  AtomicMultiSend owner: 0x42e6047c5780B103E52265F6483C2d0113aA6B87
```

**Key Information:**
- **Contract Address**: `0x247CA16B2Fc5c9ae031e83c317c6DC6933Db7246`
- **Owner**: `0x42e6047c5780B103E52265F6483C2d0113aA6B87`
- **Block**: 599458

## Step 4: Verify Deployment

Confirm the contract was deployed successfully:

```bash
curl -s -X POST https://cevm-01-evmrpc.dev.skip.build \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"eth_getCode","params":["0x247CA16B2Fc5c9ae031e83c317c6DC6933Db7246","latest"],"id":1}'
```

A successful response returns the contract bytecode (not `0x`).

## Step 5: Token Approvals

### Create Approval Script

Run the token approval script to allow the contract to spend tokens:

```bash
node scripts/approve-tokens.js
```

### Real Approval Results

```
============================================================
APPROVING TOKENS FOR ATOMIC MULTISEND
============================================================
Faucet Address: 0x42e6047c5780B103E52265F6483C2d0113aA6B87
AtomicMultiSend Address: 0x247CA16B2Fc5c9ae031e83c317c6DC6933Db7246

Processing token: wbtc
Contract: 0xC52cB914767C076919Dc4245D4B005c8865a2f1F
  Symbol: WBTC
  Decimals: 8
  Faucet Balance: 999999999.98
  Current Allowance: 0.0
  Approving 1000000.0 WBTC...
  Transaction hash: 0xd791c51ff81a8dd7eec41289c67163d86630a8b91f5eefc1221b87f72fe98fbe
  Approval confirmed in block 599472
  New Allowance: 1000000.0 WBTC
```

**What This Achieves:**
- Sets 1M token allowance for each ERC20 token
- Enables the AtomicMultiSend contract to transfer tokens on behalf of the faucet
- Provides transaction hashes for verification

## Step 6: Address Conversion Setup

### Test Address Conversion

Cosmos EVM requires converting between hex and bech32 addresses:

```bash
node test-address-conversion.js
```

### Working Conversion Results

```
============================================================
ADDRESS CONVERSION TEST
============================================================
Faucet Hex Address: 0x42e6047c5780B103E52265F6483C2d0113aA6B87
Expected Bech32: cosmos1gtnqglzhszcs8efzvhmys0pdqyf656u8wmfcuz
Converted to Bech32: cosmos1gtnqglzhszcs8efzvhmys0pdqyf656u8wmfcuz
Converted back to Hex: 0x42e6047c5780b103e52265f6483c2d0113aa6b87
Round-trip Bech32: cosmos1gtnqglzhszcs8efzvhmys0pdqyf656u8wmfcuz

============================================================
VALIDATION RESULTS
============================================================
Hex addresses match: âœ“
Bech32 addresses match: âœ“
Round-trip conversion: âœ“

ðŸŽ‰ All conversions working correctly!
```

### Working Conversion Function

```javascript
function hexToBech32(hexAddress, prefix = 'cosmos') {
  const cleanHex = hexAddress.replace('0x', '');
  const bytes = Buffer.from(cleanHex, 'hex');
  const words = bech32.toWords(bytes);
  const encoded = bech32.encode(prefix, words);
  return encoded;
}
```

## Step 7: Configure Faucet

### Update Contract Configuration

```javascript
// config.js
contracts: {
    atomicMultiSend: "0x247CA16B2Fc5c9ae031e83c317c6DC6933Db7246"
}
```

### Token Configuration

```javascript
amounts: [
    {
        denom: "wbtc",
        amount: "100000000000", // 1000 WBTC (8 decimals)
        erc20_contract: "0xC52cB914767C076919Dc4245D4B005c8865a2f1F",
        decimals: 8,
        target_balance: "100000000000"
    },
    {
        denom: "pepe",
        amount: "1000000000000000000000", // 1000 PEPE (18 decimals)
        erc20_contract: "0xD0C124828bF8648E8681d1eD3117f20Ab989e7a1",
        decimals: 18,
        target_balance: "1000000000000000000000"
    },
    {
        denom: "usdt",
        amount: "1000000000", // 1000 USDT (6 decimals)
        erc20_contract: "0xf66bB908fa291EE1Fd78b09937b14700839E7c80",
        decimals: 6,
        target_balance: "1000000000"
    }
]
```

## Step 8: Test Token Distribution

### Execute Test Transaction

```bash
curl "http://localhost:8088/send/0x3428147483e2b5e7593F7305b67e68EC40815516"
```

### Successful Response

```json
{
  "result": {
    "code": 0,
    "message": "Tokens sent successfully!",
    "transaction_hash": "0x33625bc4c89f06c984cea94cdf67686d2c2df0cbe21d26e68a2bcf4e6b2eed49",
    "block_number": 600106,
    "gas_used": "386194",
    "transfers": [
      {
        "token": "0xC52cB914767C076919Dc4245D4B005c8865a2f1F",
        "amount": "100000000000",
        "denom": "wbtc",
        "hash": "0x33625bc4c89f06c984cea94cdf67686d2c2df0cbe21d26e68a2bcf4e6b2eed49",
        "status": 1,
        "type": "erc20"
      },
      {
        "token": "0xD0C124828bF8648E8681d1eD3117f20Ab989e7a1",
        "amount": "1000000000000000000000",
        "denom": "pepe",
        "hash": "0x33625bc4c89f06c984cea94cdf67686d2c2df0cbe21d26e68a2bcf4e6b2eed49",
        "status": 1,
        "type": "erc20"
      },
      {
        "token": "0xf66bB908fa291EE1Fd78b09937b14700839E7c80",
        "amount": "1000000000",
        "denom": "usdt",
        "hash": "0x33625bc4c89f06c984cea94cdf67686d2c2df0cbe21d26e68a2bcf4e6b2eed49",
        "status": 1,
        "type": "erc20"
      },
      {
        "token": "native",
        "amount": "1000000",
        "denom": "uatom",
        "status": 1,
        "type": "cosmos_native"
      }
    ]
  }
}
```

**Key Metrics:**
- **Gas Used**: 386,194 (reasonable for atomic 3-token transfer)
- **All transfers executed atomically** in single transaction
- **Transaction hash**: `0x33625bc4c89f06c984cea94cdf67686d2c2df0cbe21d26e68a2bcf4e6b2eed49`

## Step 9: Verify Token Balances

### Check Recipient Balances

```bash
node -e "
import('./config.js').then(config => {
  import('ethers').then(ethers => {
    const provider = new ethers.ethers.JsonRpcProvider(config.default.blockchain.endpoints.evm_endpoint);
    const abi = ['function balanceOf(address) view returns (uint256)', 'function decimals() view returns (uint8)'];
    const testAddr = '0x3428147483e2b5e7593F7305b67e68EC40815516';
    const tokens = [
      { addr: '0xC52cB914767C076919Dc4245D4B005c8865a2f1F', name: 'WBTC' },
      { addr: '0xD0C124828bF8648E8681d1eD3117f20Ab989e7a1', name: 'PEPE' },
      { addr: '0xf66bB908fa291EE1Fd78b09937b14700839E7c80', name: 'USDT' }
    ];
    Promise.all(tokens.map(async t => {
      const contract = new ethers.ethers.Contract(t.addr, abi, provider);
      const [balance, decimals] = await Promise.all([contract.balanceOf(testAddr), contract.decimals()]);
      return \`\${t.name}: \${ethers.ethers.formatUnits(balance, decimals)}\`;
    })).then(results => console.log('Balances:', results.join(', ')));
  });
});
"
```

**Result**: `Balances: WBTC: 1000.0, PEPE: 1000.0, USDT: 1000.0`

## Network Configuration

### Cosmos EVM Testnet Details

```bash
# Network Information
Chain ID: 262144 (0x40000)
Cosmos Chain ID: cosmos_262144-1
EVM RPC: https://cevm-01-evmrpc.dev.skip.build
Cosmos RPC: https://cevm-01-rpc.dev.skip.build
LCD: https://cevm-01-lcd.dev.skip.build
WebSocket: wss://cevm-01-evmws.dev.skip.build
```

### Final Contract Addresses

```bash
# Deployed Contracts
AtomicMultiSend: 0x247CA16B2Fc5c9ae031e83c317c6DC6933Db7246
WBTC: 0xC52cB914767C076919Dc4245D4B005c8865a2f1F
PEPE: 0xD0C124828bF8648E8681d1eD3117f20Ab989e7a1
USDT: 0xf66bB908fa291EE1Fd78b09937b14700839E7c80

# Faucet Addresses
EVM: 0x42e6047c5780B103E52265F6483C2d0113aA6B87
Cosmos: cosmos1gtnqglzhszcs8efzvhmys0pdqyf656u8wmfcuz
```

## Performance Metrics

### Gas Usage
- **Contract deployment**: ~3,000,000 gas
- **Token approval**: ~50,000 gas per token
- **3-token atomic transfer**: 386,194 gas

### Transaction Times
- **EVM transactions**: 2-5 seconds
- **Cosmos transactions**: 3-7 seconds
- **Block confirmation**: Fast consensus

## Common Issues and Solutions

### Issue: WERC20 Precompile Unavailable

**Problem**: WERC20 precompile returns "execution reverted"
```bash
# Fails with current devnet
werc20.deposit({ value: wrapAmount, gasLimit: 200000 })
```

**Solution**: WERC20 precompile not enabled on current devnet. Will be available in future updates.

### Issue: Native Token Transfer Failures

**Problem**: Native tokens fail to send to random addresses
**Error**: `"AtomicMultiSend: native token transfer failed"`

**Solution**: Use real wallet addresses instead of random hex addresses for testing.

### Issue: Stale Contract Artifacts

**Problem**: Deployment uses wrong contract version
**Solution**: Always run `forge clean` before deployment

## Security Best Practices

### Private Key Management
```bash
# Good: Environment variable
export PRIVATE_KEY="0x..."

# OK: .env file
PRIVATE_KEY="0x..."

# Bad: Hardcoded in files
const PRIVATE_KEY = "0x..." // Never do this
```

### Approval Management
- Use reasonable approval amounts (1M tokens used in examples)
- Monitor and refresh approvals as needed
- Implement automatic approval renewal for production

### Contract Security
- Owner-only functions protected with `onlyOwner` modifier
- ReentrancyGuard prevents reentrancy attacks
- Atomic execution ensures all-or-nothing transfers
