# Cosmos EVM v0.5.0 - Detailed Commit Analysis

**Version Range:** v0.4.1 → v0.5.0-rc.0
**Total Commits:** 33 commits
**Date Range:** August 2025
**Focus:** Major features, breaking changes, and significant implementations

---

## Executive Summary

v0.5.0 introduces significant architectural improvements focused on:

- **Performance Optimization** - EVM instance removal in ante handlers
- **Developer Experience** - Simplified mempool configuration, decoupled precompile interfaces
- **EIP Support** - EIP-2935 (block hash storage), EIP-7212 support via eth_createAccessList
- **Security** - Re-use go-ethereum tx validation rules, improved tx processing hooks
- **Clean Architecture** - Global singleton removal, interface-based design

---

## Major Features & Implementations

### 1. EVM Instance Deletion in AnteHandler (#352)

**Commit:** `befde4fa`
**Author:** LEE JUNSEO (bharvest)
**Impact:** 🔴 CRITICAL - Performance optimization

#### What Changed

- Removed stateDB allocation in ante handler
- Optimized `CanTransfer` ante handler by eliminating unnecessary EVM instance creation
- Reduced memory overhead per transaction

#### Why It Matters

**Before:** Every transaction created a full EVM instance during ante handling, even for non-EVM transactions. This was expensive and unnecessary.

**After:** Ante handler validates transactions without creating EVM instance. EVM is only instantiated when actually executing contract calls.

**Performance Impact:**

- Reduces memory allocation per tx
- Faster ante handler execution
- Lower CPU usage on high-throughput chains

#### Migration Impact

- No API breaking changes
- Transparent performance improvement
- Internal optimization only

**Files Modified:**

```sh
ante/evm/07_can_transfer.go | 14 +-------------
```

---

### 2. Mempool Configuration Refactor (#496)

**Commit:** `e01cc507`
**Author:** Vlad J
**Impact:** 🔴 BREAKING - API change

#### What Changed

Replaced pre-built pool injection with configuration-based approach:

**Before (v0.4.x):**

```go
type EVMMempoolConfig struct {
    TxPool     *txpool.TxPool        // Pre-built pool
    CosmosPool sdkmempool.ExtMempool  // Pre-built pool
    // ...
}
```

**After (v0.5.0):**

```go
type EVMMempoolConfig struct {
    LegacyPoolConfig *legacypool.Config                                // Config object
    CosmosPoolConfig *sdkmempool.PriorityNonceMempoolConfig[math.Int]  // Config object
    // ...
}
```

#### Why It Matters

**Problem:** Pre-built pools forced users to construct complex objects before passing to mempool. This was:

- Hard to customize
- Required deep knowledge of internal structures
- Coupling between app and mempool internals

**Solution:** Configuration objects allow:

- Simple parameter tuning
- Internal pool construction by mempool
- Better separation of concerns
- Easier testing and mocking

#### Migration Required

✅ **Action Items:**

1. Remove manual pool construction
2. Pass config objects instead
3. Update initialization code

**Example Migration:**

```diff
- legacyPool := legacypool.New(config, blockchain)
- cosmosPool := sdkmempool.NewPriorityMempool(...)

  mempoolConfig := &evmmempool.EVMMempoolConfig{
-     TxPool:     txPool,
-     CosmosPool: cosmosPool,
+     LegacyPoolConfig: &legacypool.Config{
+         AccountSlots: 16,
+         GlobalSlots:  5120,
+     },
      AnteHandler: app.GetAnteHandler(),
  }
```

**Files Modified:**

```
mempool/mempool.go | 66 +++++++++++++++++++++++++++++-------------------------
```

---

### 3. Global Mempool Registry Removal (#467)

**Commit:** `aa9a8342`
**Author:** mmsqe
**Impact:** 🔴 BREAKING - Architecture change

#### What Changed

- Removed `SetGlobalEVMMempool()` function
- Removed global singleton pattern
- Mempool now passed directly to JSON-RPC server on initialization

**Removed Files:**

```
mempool/registry_production.go | 33 ------
mempool/registry_testing.go    | 28 ------
```

#### Why It Matters

**Problem with Singleton:**

- Global state is hard to test
- Race conditions on concurrent initialization
- Tight coupling between components
- Makes unit testing difficult

**Benefits of Direct Injection:**

- Explicit dependencies
- Easier to test (can inject mock mempool)
- No hidden global state
- Thread-safe by design

#### Migration Required

✅ **Action Items:**

1. Remove `SetGlobalEVMMempool()` call from app.go
2. Pass mempool to RPC server explicitly during initialization

**Before:**

```go
evmMempool := evmmempool.NewExperimentalEVMMempool(...)
if err := evmmempool.SetGlobalEVMMempool(evmMempool); err != nil {
    panic(err)
}
```

**After:**

```go
evmMempool := evmmempool.NewExperimentalEVMMempool(...)
// Pass to RPC server in server initialization
rpcServer := NewJSONRPCServer(evmMempool, ...)
```

**Files Modified:**

```
evmd/app.go                         | 4 ---
rpc/apis.go                         | 24 ++++++++++------
rpc/backend/backend.go              | 4 +++
rpc/backend/tx_pool.go              | 9 +++---
server/json_rpc.go                  | 4 ++-
server/start.go                     | 5 +++-
```

---

### 4. Precompile Interface Decoupling (#477)

**Commit:** `8903f9d7`
**Author:** yoosah
**Impact:** 🟡 BREAKING - Better architecture

#### What Changed

- Defined keeper interfaces in `precompiles/common/interfaces.go`
- Precompiles now depend on interfaces instead of concrete keepers
- Constructor signatures changed to accept `MsgServer` and `Querier` interfaces

**New Interfaces:**

```go
// precompiles/common/interfaces.go
type BankKeeper interface {
    GetBalance(ctx context.Context, addr sdk.AccAddress, denom string) sdk.Coin
    SendCoins(ctx context.Context, from, to sdk.AccAddress, amt sdk.Coins) error
    // ... only methods actually used by precompiles
}

type StakingMsgServer interface {
    Delegate(context.Context, *stakingtypes.MsgDelegate) (*stakingtypes.MsgDelegateResponse, error)
    // ... only required methods
}
```

#### Why It Matters

**Benefits:**

1. **Loose Coupling** - Precompiles don't depend on entire keeper implementations
2. **Easy Testing** - Can mock interfaces with minimal effort
3. **Clear Contracts** - Interfaces document exactly what precompiles need
4. **Future-Proof** - Keeper internals can change without affecting precompiles

#### Migration Required

✅ **Action Items:**
Update precompile initialization to pass msg servers and query servers:

**Before:**

```go
govPrecompile, err := govprecompile.NewPrecompile(
    govKeeper,
    cdc,
)
```

**After:**

```go
govPrecompile, err := govprecompile.NewPrecompile(
    govkeeper.NewMsgServerImpl(&govKeeper),   // Msg server interface
    govkeeper.NewQueryServer(&govKeeper),     // Query server interface
    bankKeeper,
    codec,
    options.AddressCodec,
)
```

**Files Modified:**

```
evmd/precompiles.go                          | 27 +++++++++++--
precompiles/common/interfaces.go (NEW)       | 45 ++++++++++++++++++++++
precompiles/distribution/distribution.go     | 25 +++++++-----
precompiles/gov/gov.go                       | 19 +++++----
precompiles/staking/staking.go               | 18 ++++++---
precompiles/slashing/slashing.go             | 19 +++++----
precompiles/ics20/ics20.go                   | 20 +++-------
```

---

### 5. EIP-2935 Implementation - Block Hash Storage (#407)

**Commit:** `f164197b`
**Author:** yihuang (Crypto.org)
**Impact:** 🟢 NEW FEATURE - EIP support

#### What Changed

- Implemented EIP-2935: Historical block hash storage in state
- Added `history_serve_window` parameter (default: 8192 blocks)
- Modified `BLOCKHASH` opcode to query contract storage
- Adapted implementation from go-ethereum

#### What is EIP-2935?

**Problem:** Smart contracts can only access the last 256 block hashes via `BLOCKHASH` opcode. This limitation prevents:

- Long-term oracle verification
- Historical proof verification
- Complex time-based logic

**Solution:** Store block hashes in state for configurable window (default 8192 blocks = ~24 hours on 10s block time).

#### Implementation Details

```go
// Stores block hash in predefined contract storage
// Contract address: 0x0000...25 (EIP-2935 spec)
stateDB.SetState(blockHashContract, slot, blockHash)
```

**Storage Format:**

- Ring buffer in contract storage
- Slot = block_number % HISTORY_SERVE_WINDOW
- Efficient overwriting of old hashes

#### Migration Required

✅ **Action Items:**

1. Add `history_serve_window` parameter to genesis
2. Remove `allow_unprotected_txs` (cleaned up in same PR)

**Genesis Update:**

```diff
{
  "vm": {
    "params": {
-     "allow_unprotected_txs": false,
+     "history_serve_window": 8192
    }
  }
}
```

**Files Modified:**

```
proto/cosmos/evm/vm/v1/evm.proto            | 1 +
x/vm/keeper/keeper.go                       | 37 +-
x/vm/keeper/state_transition.go             | 20 +-
x/vm/types/params.go                        | 3 +
x/vm/types/preinstall.go (NEW)              | 6 +
```

**Performance Impact:**

- Minimal: One storage write per block
- Ring buffer prevents unbounded growth

---

### 6. Remove allow-unprotected-txs Parameter (#415)

**Commit:** `1d8b9e1e`
**Author:** Sujong Lee
**Impact:** 🔴 BREAKING - Parameter removal

#### What Changed

- Removed `allow_unprotected_txs` from VM module parameters
- Non-EIP-155 transaction handling moved to node-level config

#### Why It Matters

**Context:** EIP-155 added chain ID to transaction signatures to prevent replay attacks across chains.

**Problem with Global Parameter:**

- Should be node-level decision (operator's choice)
- Shouldn't be consensus parameter
- Different nodes may want different policies

**Solution:**

- Removed from state/consensus
- Operators configure per-node if needed
- Reduces attack surface at consensus layer

#### Migration Required

✅ **Action Items:**

1. Remove parameter from genesis
2. Remove code referencing `AllowUnprotectedTxs`
3. If needed, configure at node level (outside consensus)

**Files Modified:**

```
ante/evm/05_signature_verification.go   | 20 +-
proto/cosmos/evm/vm/v1/evm.proto        | 6 +-
x/vm/types/params.go                    | 17 -
x/vm/types/params_legacy.go             | 12 +-
```

---

### 7. eth_createAccessList RPC Method (#346)

**Commit:** `4d93f2d0`
**Author:** Abdul Malek
**Impact:** 🟢 NEW FEATURE - RPC method

#### What Changed

- Added `eth_createAccessList` JSON-RPC method
- Supports EIP-2930 access list transactions
- Provides gas optimization for complex transactions

#### What is eth_createAccessList?

**Purpose:** Analyzes transaction execution and returns optimal access list.

**Access Lists (EIP-2930):**

- Pre-declare storage slots accessed during execution
- Reduces gas cost for those accesses
- Particularly useful for:
  - Complex contract interactions
  - Multi-contract calls
  - Heavy storage operations

**Example Usage:**

```javascript
// RPC call
eth.createAccessList({
  from: "0x...",
  to: "0x...",
  data: "0x..."
})

// Returns
{
  accessList: [
    {
      address: "0xContract1...",
      storageKeys: ["0xkey1", "0xkey2"]
    }
  ],
  gasUsed: "0x1234"
}
```

#### Benefits

- **Gas Optimization** - Can save 5-20% gas on complex txs
- **Tool Compatibility** - Required by many Ethereum dev tools
- **User Experience** - Wallets can optimize gas automatically

**Files Modified:**

- Extensive changes across RPC layer
- Access list generation logic
- Gas estimation improvements

---

### 8. PostTxProcessing Hook Improvements (#479)

**Commit:** `2cf6593f`
**Author:** Facundo Medica (Informal Systems)
**Impact:** 🟡 ENHANCEMENT - Hook behavior

#### What Changed

- `PostTxProcessing` hooks now run even on transaction failures
- Hook data is persisted regardless of tx success/failure
- More reliable event emission and state tracking

#### Why It Matters

**Before:** Hooks only ran on successful transactions, causing:

- Missed events for failed txs
- Incomplete metrics/analytics
- Lost tracking data

**After:** Hooks always run, enabling:

- Complete transaction lifecycle tracking
- Failed transaction analytics
- Comprehensive event logging
- Better monitoring and debugging

**Use Cases:**

- IBC callbacks need to know about failures
- Metrics systems track all attempts
- Debugging failed transactions
- Audit logs must be complete

#### Migration Impact

- No breaking changes
- Enhanced functionality
- Hooks should handle failure cases

**Files Modified:**

```
x/vm/keeper/keeper.go           | 5 +
x/vm/keeper/state_transition.go | 85 ++++++++----
```

---

### 9. Re-use go-ethereum TX Validation Rules (#286)

**Commit:** `6492ef5b`
**Author:** yihuang (Crypto.org)
**Impact:** 🟢 ENHANCEMENT - Better compatibility

#### What Changed

- Delegated transaction validation to go-ethereum's validation logic
- Ensures 100% compatibility with Ethereum transaction rules
- Reduces custom validation code

#### Why It Matters

**Benefits:**

1. **Compatibility** - Matches Ethereum behavior exactly
2. **Maintenance** - Automatic updates when go-ethereum updates
3. **Security** - Leverages battle-tested validation
4. **Consistency** - Same rules as mainnet Ethereum

**Validation Rules Inherited:**

- Gas limit validation
- Gas price validation
- Nonce validation
- Signature validation
- Transaction type checks

#### Migration Impact

- No breaking changes
- More restrictive validation in some edge cases
- Better error messages matching Ethereum

**Files Modified:**

```
ante/evm/05_signature_verification.go | 4 ++--
ante/evm/mono_decorator.go            | 26 ++++++++++++++++++++++
x/vm/keeper/state_transition.go       | 12 +++++++++-
```

---

## Medium Priority Changes

### 10. Mempool New Block Notification Fix (#471)

**Commit:** `642c8e98`
**Author:** Community
**Impact:** 🟡 FIX - Race condition

**Problem:** Mempool wasn't notified of new blocks in time, causing "insufficient funds" errors when funding and sending tx in same block.

**Solution:** Improved timing of mempool block notifications.

---

### 11. IsStorageEmpty Implementation (#490)

**Commit:** `1f22f197`
**Author:** Community
**Impact:** 🟡 FIX - Missing method

**Problem:** `IsStorageEmpty` method not implemented in state DB.

**Solution:** Added proper implementation for contract storage emptiness checks.

---

### 12. Decimals Query Fix for IBC Tokens (#397)

**Commit:** `810e9ef0`
**Author:** Community
**Impact:** 🟡 FIX - IBC compatibility

**Problem:** Decimals query reverted when Display doesn't match DenomUnit for IBC tokens.

**Solution:** Improved metadata handling for IBC token decimals.

---

### 13. PreciseBank & WERC20 Precompile Fixes (#457)

**Commit:** `29c1fac8`
**Author:** Community
**Impact:** 🟡 FIX + FEATURE

**Added:**

- `FractionalBalanceChange` event for tracking sub-unit balance changes
- Improved WERC20 precompile precision handling

---

### 14. Token-Pairs Query Pagination (#468)

**Commit:** `7dc893df`
**Author:** Community
**Impact:** 🟡 FIX - Query improvement

**Added:** Pagination flags to token-pairs query for better API usability.

---

### 15. BalanceChangeEntry Cleanup (#506)

**Commit:** `750d77d9`
**Author:** mmsqe
**Impact:** 🟢 CLEANUP

**Removed:** Deprecated `BalanceChangeEntry` tracing code, aligned with go-ethereum v1.16.2 balance change tracking.

---

## Documentation & Testing

### 16. ERC20 Migration Guide (#485)

**Commit:** `a9cb4011`
**Author:** Documentation team
**Impact:** 📚 DOCS

Added comprehensive guide for ERC20 precompile storage migration.

---

### 17. SetClientCtx Migration Instructions (#481)

**Commit:** `909c8e2b`
**Author:** Documentation team
**Impact:** 📚 DOCS

Added instructions for implementing `SetClientCtx` method during migration.

---

### 18. Upgrade Test (v0.4.1 → main) (#498)

**Commit:** `48e3c833`
**Author:** Tyler
**Impact:** ✅ TEST

Added comprehensive upgrade test suite for v0.4.1 → v0.5.0 migration.

---

### 19. JSON-RPC Compatibility Tests (#419)

**Commit:** `ab1cd0cf`
**Author:** Testing team
**Impact:** ✅ TEST

Added JSON-RPC compatibility test suite to ensure Ethereum tooling works correctly.

---

### 20. EVM Tools Compatibility Tests (#287)

**Commit:** `204ff4ea`
**Author:** Testing team
**Impact:** ✅ TEST

Added tests for Hardhat, Foundry, and other popular Ethereum development tools.

---

### 21. Revert Error E2E Tests (#476)

**Commit:** `3991c2c4`
**Author:** Testing team
**Impact:** ✅ TEST

Added end-to-end tests for revert errors in both contract and precompile calls.

---

## Minor Changes & Fixes

### 22. Duplicate Switch Case Fix (#492)

**Commit:** `03083a8b`
**Impact:** 🟢 FIX - Code quality
Fixed duplicate case in switch statement to avoid empty execution blocks.

---

### 23. Deprecated Allowance Functions Cleanup (#472)

**Commit:** `1bdd7d2a`
**Impact:** 🟢 CLEANUP
Removed deprecated `increaseAllowance` and `decreaseAllowance` functions.

---

### 24. Local Node Upgrade Scripts (#470)

**Commit:** `39ddca42`
**Impact:** 🔧 TOOLING
Improved `local_node.sh` script with upgrade testing support.

---

### 25. Contracts Compile Script Update (#475)

**Commit:** `b9bdbe6a`
**Impact:** 🔧 TOOLING
Updated contract compilation scripts for better developer experience.

---

### 26. RPC Accessibility Fix (#469)

**Commit:** `a2599769`
**Impact:** 🟡 FIX
Fixed RPC endpoint accessibility issues.

---

### 27. CI Workflow Improvement (#499)

**Commit:** `2d3df2ba`
**Impact:** 🔧 CI
Workflow now fails when feat/fix/refactor PRs don't have CHANGELOG entry.

---

### 28. Version Retraction (#464, #465)

**Commits:** `384ea4a2`, `dd448d29`
**Impact:** 🔧 VERSION
Retracted problematic intermediate versions.

---

### 29. Mergify Config Update (#463)

**Commit:** `dd448d29`
**Impact:** 🔧 CI
Updated Mergify configuration for better PR automation.

---

## Breaking Changes Summary

### API Breaking Changes

| Change                  | Impact | Migration Required       |
| ----------------------- | ------ | ------------------------ |
| Mempool config refactor | HIGH   | Update config struct     |
| Global mempool removal  | HIGH   | Pass mempool to RPC      |
| Precompile interfaces   | MEDIUM | Update constructor calls |
| VM params removal       | MEDIUM | Update genesis           |
| Hook behavior           | LOW    | Handle failure cases     |

### Required Migrations

1. **Update `EVMMempoolConfig`**

   - Remove `TxPool` and `CosmosPool` fields
   - Add `LegacyPoolConfig` and `CosmosPoolConfig`

2. **Remove Global Mempool**

   - Delete `SetGlobalEVMMempool()` call
   - Pass mempool to RPC server explicitly

3. **Update Precompile Initialization**

   - Pass msg/query servers instead of keepers
   - Add bank keeper to ICS-20 precompile
   - Add address codec to Gov precompile

4. **Update Genesis**

   - Remove `allow_unprotected_txs`
   - Add `history_serve_window: 8192`

5. **Implement App `Close()` Method**
   - Add proper cleanup logic
   - Handle mempool shutdown

---

## New Features Summary

| Feature                     | Benefit                        | Use Case                    |
| --------------------------- | ------------------------------ | --------------------------- |
| EIP-2935                    | Historical block hash access   | Oracle verification, proofs |
| eth_createAccessList        | Gas optimization               | Complex transactions        |
| Interface-based precompiles | Better testing, loose coupling | Development, maintenance    |
| PostTx hooks on failure     | Complete lifecycle tracking    | Monitoring, debugging       |
| Go-ethereum validation      | Perfect Ethereum compatibility | Tool support                |

---

## Performance Improvements

1. **EVM Instance Removal** - Reduced memory allocation per transaction
2. **Optimized Ante Handler** - Faster tx validation
3. **Access List Support** - 5-20% gas savings on complex txs
4. **Better Memory Management** - Reduced heap pressure

---

## Developer Experience Improvements

1. **Simpler Configuration** - Config objects vs pre-built pools
2. **Better Testing** - Interface-based design
3. **Improved Documentation** - Migration guides and examples
4. **Better Error Messages** - Matching Ethereum exactly
5. **Comprehensive Test Suite** - JSON-RPC, tool compatibility

---

## Security Enhancements

1. **Go-ethereum Validation** - Battle-tested rules
2. **Removed Global State** - Thread-safe design
3. **Parameter Cleanup** - Reduced attack surface
4. **Better Hook Handling** - Consistent state management

---

## Compatibility Matrix

| Tool/Framework | v0.4.x | v0.5.0 | Notes         |
| -------------- | ------ | ------ | ------------- |
| Hardhat        | ✅     | ✅     | Full support  |
| Foundry        | ✅     | ✅     | Full support  |
| Remix          | ✅     | ✅     | Full support  |
| MetaMask       | ✅     | ✅     | Full support  |
| Ethers.js      | ✅     | ✅     | Full support  |
| Web3.js        | ✅     | ✅     | Full support  |
| Access Lists   | ❌     | ✅     | NEW in v0.5.0 |
| EIP-2935       | ❌     | ✅     | NEW in v0.5.0 |

---

## Upgrade Checklist

### Pre-Upgrade

- [ ] Review all breaking changes
- [ ] Test upgrade on devnet
- [ ] Update genesis file (remove allow_unprotected_txs, add history_serve_window)
- [ ] Update app.go for mempool changes
- [ ] Update precompile initialization

### During Upgrade

- [ ] Run upgrade handler
- [ ] Monitor for errors
- [ ] Check mempool operation
- [ ] Verify RPC endpoints

### Post-Upgrade

- [ ] Test eth_createAccessList
- [ ] Verify EIP-2935 block hash storage
- [ ] Check gas estimation accuracy
- [ ] Monitor performance metrics

---

## Resources

- **Upgrade Handler:** See `evmd/upgrades.go`
- **Mempool README:** See `mempool/README.md`
- **Migration Guide:** See `docs/migrations/v0.3.0_to_v0.4.0.md` (template for v0.5)
- **Test Suite:** See `tests/integration/`

---

## Contributors

Major contributions from:

- **Vlad J** (Cosmos/EVM team) - Mempool refactor, architecture
- **mmsqe** (Crypto.org) - Global mempool removal, cleanup
- **yihuang** (Crypto.org) - EIP-2935, go-ethereum validation
- **yoosah** - Precompile interface decoupling
- **LEE JUNSEO** (bharvest) - Performance optimizations
- **Abdul Malek** - eth_createAccessList implementation
- **Facundo Medica** (Informal Systems) - Hook improvements
- **Tyler** - Testing and CI improvements

---

**Document Version:** 1.0
**Last Updated:** 2025-10-10
**Status:** Draft for documentation team review
